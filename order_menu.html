<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Service Menu & Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center min-h-screen">

    <div class="w-full max-w-lg bg-white shadow-xl rounded-xl p-6 sm:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Room Service ‚Äî –ú–µ–Ω—é</h1>
        <p id="response-message" class="text-center font-medium py-3 rounded-lg hidden"></p>

        <div id="menu-items" class="space-y-4 mb-8">
            </div>

        <form id="order-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-700 pt-4 border-t mt-6">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</h2>
            
            <div>
                <label for="dish-select" class="block text-sm font-medium text-gray-700 mb-1">–í—ã–±—Ä–∞–Ω–Ω–æ–µ –±–ª—é–¥–æ:</label>
                <select id="dish-select" name="dish_id" required 
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    </select>
            </div>

            <div>
                <label for="room-number" class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã</label>
                <input type="text" id="room-number" name="room_number" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 405"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>

            <div>
                <label for="full-name" class="block text-sm font-medium text-gray-700 mb-1">–§–ò–û –ì–æ—Å—Ç—è</label>
                <input type="text" id="full-name" name="full_name" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            
            <div>
                <label for="phone-number" class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="tel" id="phone-number" name="phone_number" required placeholder="+7 (900) 123-45-67"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>

            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="guests-count" class="block text-sm font-medium text-gray-700 mb-1">–ö–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π</label>
                    <input type="number" id="guests-count" name="guests_count" required min="1" value="1"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="w-1/2">
                    <label for="delivery-time" class="block text-sm font-medium text-gray-700 mb-1">–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                    <input type="time" id="delivery-time" name="delivery_time" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>

            <button type="submit" id="submit-button"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
            <div id="loading-indicator" class="hidden text-center text-green-600">
                <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞...</p>
            </div>
        </form>
    </div>

<script>
        // *** üü¢ –ê–ö–¢–£–ê–õ–¨–ù–´–ô URL –í–ê–®–ï–ì–û FLASK –°–ï–†–í–ï–†–ê üü¢ ***
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å CORS,
        // —Ç–∞–∫ –∫–∞–∫ HTML —Ç–µ–ø–µ—Ä—å –æ—Ç–¥–∞–µ—Ç—Å—è —Å–∞–º–∏–º Flask-—Å–µ—Ä–≤–µ—Ä–æ–º.
        const FLASK_API_URL = "/api/place_order"; 
        // *************************************************************************

        const MENU_DATA = {
            "B001": { "name": "–ó–∞–≤—Ç—Ä–∞–∫", "price": 12.50 },
            "L001": { "name": "–ü–∞—Å—Ç–∞ –ü–µ—Å—Ç–æ", "price": 15.00 },
            "D001": { "name": "–°–≤–µ–∂–µ–≤—ã–∂–∞—Ç—ã–π —Å–æ–∫", "price": 5.00 }
        };

        const form = document.getElementById('order-form');
        const dishSelect = document.getElementById('dish-select');
        const menuItemsDiv = document.getElementById('menu-items');
        const messageDiv = document.getElementById('response-message');
        const submitButton = document.getElementById('submit-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º–µ–Ω—é –∏ —Ñ–æ—Ä–º—ã ---
        function initializeMenu() {
            let menuHtml = '';
            let selectOptions = '';
            
            for (const id in MENU_DATA) {
                const item = MENU_DATA[id];
                menuHtml += `
                    <div class="flex justify-between items-center p-3 border rounded-lg bg-gray-50">
                        <span class="text-gray-900 font-semibold">${item.name} (${id})</span>
                        <span class="text-indigo-600 font-bold">$${item.price.toFixed(2)}</span>
                    </div>
                `;
                selectOptions += `<option value="${id}">${item.name} ($${item.price.toFixed(2)})</option>`;
            }
            
            menuItemsDiv.innerHTML = menuHtml;
            dishSelect.innerHTML = selectOptions;

            const now = new Date();
            const timeString = now.toTimeString().slice(0, 5);
            document.getElementById('delivery-time').value = timeString;
        }

        // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ---
        function showMessage(type, text) {
            messageDiv.textContent = text;
            messageDiv.className = 'text-center font-medium py-3 rounded-lg block';
            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageDiv.scrollIntoView({ behavior: 'smooth' });
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            // setTimeout(() => { messageDiv.classList.add('hidden'); }, 5000); 
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (—Ç–µ–ø–µ—Ä—å –Ω–∞ Flask) ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            
            // 1. –ë–ª–æ–∫–∏—Ä—É–µ–º UI
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');
            loadingIndicator.classList.remove('hidden');
            messageDiv.classList.add('hidden');

            try {
                // 2. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const selectedDishId = dishSelect.value;
                const selectedDish = MENU_DATA[selectedDishId];
                
                const formData = {
                    "guest_name": document.getElementById('full-name').value,
                    "room_number": document.getElementById('room-number').value,
                    "phone_number": document.getElementById('phone-number').value,
                    "delivery_time": document.getElementById('delivery-time').value,
                    "guest_count": parseInt(document.getElementById('guests-count').value),
                    "order_details": { // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–∫–∞–∑–∞
                        [selectedDish.name]: 1 // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ 1 —à—Ç—É–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª—é–¥–∞
                    }
                };

                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ Flask-—Å–µ—Ä–≤–µ—Ä
                const response = await fetch(FLASK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();

                // 4. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                if (response.ok) { // –ï—Å–ª–∏ HTTP-—Å—Ç–∞—Ç—É—Å 2xx
                    showMessage('success', result.message || "–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                    form.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    initializeMenu(); // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω—é
                } else { // –ï—Å–ª–∏ HTTP-—Å—Ç–∞—Ç—É—Å 4xx –∏–ª–∏ 5xx
                    showMessage('error', result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞.");
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞:', error);
                // –≠—Ç–æ –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω–æ, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω)
                showMessage('error', "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Flask-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.");
            } finally {
                // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º UI
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50');
                loadingIndicator.classList.add('hidden');
            }
        });

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = initializeMenu;

    </script>
</body>
</html>